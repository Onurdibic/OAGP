#ifndef MOTOR_H
#define MOTOR_H

#include "stm32f1xx_hal.h"  // MCU modeline göre güncelle

#define HALLS_PER_REV 90
#define DT_SEC 0.005f   // 5 ms
#define RADIUS 0.085f   // metre
#define MOVING_AVG_SIZE 10

// Motor yönleri
enum MotorDirection {
    ILERI = 0,
    GERI  = 1
};

class Motor {
private:
    // Timer & PWM kanalları
    TIM_HandleTypeDef *htim;
    TIM_HandleTypeDef *htim_timebase;
    uint32_t tim_channel_a;
    uint32_t tim_channel_b;
    uint32_t tim_channel_c;

    // Low side MOSFET pinleri
    GPIO_TypeDef *AL_GPIO_Port;
    uint16_t AL_Pin;
    GPIO_TypeDef *BL_GPIO_Port;
    uint16_t BL_Pin;
    GPIO_TypeDef *CL_GPIO_Port;
    uint16_t CL_Pin;

    // Hall sensör pinleri
    GPIO_TypeDef *HallA_Port;
    uint16_t HallA_Pin;
    GPIO_TypeDef *HallB_Port;
    uint16_t HallB_Pin;
    GPIO_TypeDef *HallC_Port;
    uint16_t HallC_Pin;

    // Hall sensöründen alınan state
    uint8_t HallState;

public:
    // Constructor
    Motor(TIM_HandleTypeDef *htim_, TIM_HandleTypeDef *htim_timebase_,
          uint32_t ch_a, uint32_t ch_b, uint32_t ch_c,
          GPIO_TypeDef *AL_Port, uint16_t AL_Pin_,
          GPIO_TypeDef *BL_Port, uint16_t BL_Pin_,
          GPIO_TypeDef *CL_Port, uint16_t CL_Pin_,
          GPIO_TypeDef *HallA_Port_, uint16_t HallA_Pin_,
          GPIO_TypeDef *HallB_Port_, uint16_t HallB_Pin_,
          GPIO_TypeDef *HallC_Port_, uint16_t HallC_Pin_);

    // Motoru başlat
    void init();

    // Hall sensörlerini oku ve deltaTime hesapla
    void updateHall();

    // Komutasyon işlemi
    void komutasyon(uint16_t dutyCycle);

    // Motor yönünü ayarla
    void setDirection(MotorDirection dir);

    // Motor yönünü al
    MotorDirection getDirection() const { return direction; }

    // Motor hızı hesaplama
    void hizHesaplaFiltered(float deltaSaniye);

    // PI kontrol ile PWM güncelle
    void updatePWM(int rpm_hedef, float dt);

    // Motor durumları
    bool aktif;

    // Ölçülen hız ve RPM
    uint16_t hallCounter = 0;
    float m_rev_s = 0.0f;
    float m_rad_s = 0.0f;
    float m_rpm = 0.0f;
    float m_speed_ms = 0.0f;

private:
    // Kayan ortalama buffer
    float m_rpm_buffer[MOVING_AVG_SIZE] = {0};
    float m_speed_buffer[MOVING_AVG_SIZE] = {0};
    int ma_index = 0;

    // PID parametreleri
    float Kp = 0.4f;
    float Ki = 0.02f;
    float I_LIMIT = 200.0f;

    float integral = 0.0f;   // PI integral
    MotorDirection direction;
};

#endif // MOTOR_H
