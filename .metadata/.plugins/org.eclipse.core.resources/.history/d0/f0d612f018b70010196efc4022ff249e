/*
 * Motor.h
 *
 *  Created on: Sep 20, 2025
 *      Author: T_rab
 */
#ifndef MOTOR_H
#define MOTOR_H

#include "stm32f1xx_hal.h"  // MCU modelinize göre güncelleyin
#define HALLS_PER_REV 90
#define DT_SEC 0.005f  // 5 ms
#define RADIUS 0.085f  // metre
// Motor yönleri için enum
enum MotorDirection {
    ILERI = 0,
    GERI  = 1
};

#define MOVING_AVG_SIZE 10

class Motor {
private:
    // Timer & PWM kanalları
    TIM_HandleTypeDef *htim;           // PWM timer
    TIM_HandleTypeDef *htim_timebase;  // Hall zamanı ölçmek için timer (örn: TIM2)
    uint32_t tim_channel_a;
    uint32_t tim_channel_b;
    uint32_t tim_channel_c;

    // Low side MOSFET pinleri
    GPIO_TypeDef *AL_GPIO_Port;
    uint16_t AL_Pin;
    GPIO_TypeDef *BL_GPIO_Port;
    uint16_t BL_Pin;
    GPIO_TypeDef *CL_GPIO_Port;
    uint16_t CL_Pin;

    // Hall sensör pinleri
    GPIO_TypeDef *HallA_Port;
    uint16_t HallA_Pin;
    GPIO_TypeDef *HallB_Port;
    uint16_t HallB_Pin;
    GPIO_TypeDef *HallC_Port;
    uint16_t HallC_Pin;

    // Hall sensöründen alınan state
    uint8_t HallState;

    // Motor yönü
    MotorDirection direction;

public:
    // Constructor
    Motor(TIM_HandleTypeDef *htim_, TIM_HandleTypeDef *htim_timebase_,
          uint32_t ch_a, uint32_t ch_b, uint32_t ch_c,
          GPIO_TypeDef *AL_Port, uint16_t AL_Pin_,
          GPIO_TypeDef *BL_Port, uint16_t BL_Pin_,
          GPIO_TypeDef *CL_Port, uint16_t CL_Pin_,
          GPIO_TypeDef *HallA_Port_, uint16_t HallA_Pin_,
          GPIO_TypeDef *HallB_Port_, uint16_t HallB_Pin_,
          GPIO_TypeDef *HallC_Port_, uint16_t HallC_Pin_);

    // Motoru başlat
    void init();

    // Hall sensörlerini oku ve deltaTime hesapla
    void updateHall();

    // Komutasyon işlemi
    void komutasyon(uint16_t dutyCycle);

    // Motor yönünü ayarla
    void setDirection(MotorDirection dir);

    void hizHesapla(float deltaSaniye);
    void hizHesaplaFiltered(float deltaSaniye);
    int PIKontrol(float rpm_hedef, float rpm_olculen, float *integral);
    // Motor yönünü al
    MotorDirection getDirection() const { return direction; }

    // Motor durumları
    bool aktif;         // Motor aktif mi
    uint16_t hallCounter = 0;

    // Hesaplanan hız değerleri
	float m_rev_s = 0.0f;   // devir/s
	float m_rad_s = 0.0f;   // rad/s
	float m_rpm   = 0.0f;   // rpm
	float m_speed_ms = 0.0f; // doğrusal hız (m/s)

	float m_rpm_buffer[MOVING_AVG_SIZE] = {0};
	float m_speed_buffer[MOVING_AVG_SIZE] = {0};
	int ma_index = 0;

};

#endif // MOTOR_H
